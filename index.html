<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
  <meta charset="utf-8">
  <!-- don't zoom the page (will instead zoom on map) -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui">
  <meta name="description" content="CCAMLR interactive web map demo using Leaflet">

  <title>CCAMLR interactive web map demo</title>

  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="./favicon.ico?v=1">

  <!-- pre-connect to CDN, also with crossorigin -->
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <!-- preconnect to GBIF tiles -->
  <link rel="preconnect" href="https://tile.gbif.org">
  <link rel="preconnect" href="https://tile.gbif.org" crossorigin>

  <!-- Leaflet.js style from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin="anonymous">
  <!-- basic CSS reset, adapted from https://piccalil.li/blog/a-modern-css-reset/ -->
  <style>
    /* reset: box sizing rules */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    /* reset: remove default margin */
    body, h1, h2, h3, h4, p, figure, blockquote, dl, dd {
      margin: 0;
    }
    /* reset: inherit fonts for inputs and buttons */
    input, button, textarea, select {
      font: inherit;
    }
  </style>
  <!-- noscript styles adapted from https://stackoverflow.com/a/9028106
       note we need to remove "no-js" class from document after page is loaded using javascript -->
  <style>
    .no-js > body > * {
      display: none;
    }
    .no-js > body > noscript {
      display: block;
    }
  </style>
  <!-- page styles -->
  <style>
    body {
      /* remove margin & padding on body */
      margin: 0;
      padding: 0;
    }
    /* make map fill whole page */
    html, body, #map {
      height: 100%;
      width: 100vw;
    }
    body, .leaflet-container {
      /* override body, Leaflet font with system font stack from https://systemfontstack.com/ */
      font-family: -apple-system, BlinkMacSystemFont, avenir next, avenir, segoe ui, helvetica neue, helvetica, Ubuntu, roboto, noto, arial, sans-serif;
    }
    /* aesthetics only - re-color GBIF basemap layer from greys to blues
       inspired by https://tomik23.github.io/leaflet-examples/#48.tiles-gray */
    .basemap-layer {
      filter: sepia(30%) hue-rotate(160deg) contrast(120%);
    }

    /* at very narrow widths (under 660px), move the scale above acknowledgements */
    @media (max-width: 660px) {
      .leaflet-control-scale {
        margin-bottom: 24px !important;
      }
    }

    /* save space by removing Leaflet icon SVG */
    .leaflet-control-attribution > a > svg {
      display: none !important;
      visibility: hidden;
    }
  </style>
  <script type="text/javascript">
    'use strict';
    // script removal of "no-js" class from document after page is loaded
    // adapted from https://stackoverflow.com/a/22744494
    document.documentElement.className = '';
  </script>
</head>
<body>
  <!-- map DIV -->
  <div id="map" role="main" aria-label="Map, pan with arrow keys, zoom with plus and minus keys"></div>

  <!-- show message advising the site does not work without javascript -->
  <noscript>
    <div style="height: 220px; display: flex; align-items: center; justify-content: center; margin-left: 40px; margin-right: 40px">
      <p style="font-size: 40px; text-align: center">You need to enable javascript in your browser to use this web site.</p>
    </div>
  </noscript>
  
  <!-- Leaflet.js script from CDN -->
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin="anonymous"></script>
  <!-- Proj4.js from CDN, see https://github.com/proj4js/proj4js -->
  <script src="https://unpkg.com/proj4@2.7.5/dist/proj4-src.js" integrity="sha512-v9fKB/Tdskpid8kkFcCde7j8nyykKK9fBAZIU8pzTuMIOMJYccsutTxn8qUS/p/32FG/ynVrsbj+dsaya/jNEg==" crossorigin="anonymous"></script>
  <!-- Proj4Leaflet from CDN, see https://github.com/kartena/Proj4Leaflet -->
  <script src="https://unpkg.com/proj4leaflet@1.0.2/src/proj4leaflet.js" integrity="sha512-NA+0vegFw6AiYXT23H+hk43LxqwpJkkviK/vHTESeu+jUpvWssfQRWWqSR07aUhGSKtfpkdlE8YFrVaHsnb3jw==" crossorigin="anonymous"></script>

  <!-- Pouch db for in-browser caching from CDN, see https://pouchdb.com/ -->
  <script src="https://unpkg.com/pouchdb@^5.2.0/dist/pouchdb.js" integrity="sha512-V3KeJQJGLxtQTBpiZCjNNxVMoTgT1L8nd6/HZ9U7LrVM2CLKZttqZhyMibZetm7KGr8WO6iYmsdpdwPEltE2yA==" crossorigin="anonymous"></script>
  <!-- Leaflet.TileLayer.PouchDBCached from CDN, see https://github.com/MazeMap/Leaflet.TileLayer.PouchDBCached -->
  <script src="https://unpkg.com/leaflet.tilelayer.pouchdbcached@latest/L.TileLayer.PouchDBCached.js" integrity="sha512-1nmvAgS3BuRHdL/jYmw+Y55aagEd0xllTA9WTAAqkObDcemLTmqB0jJfLhhdN4drvX7WY671Evj+11i2U+DKTA==" crossorigin="anonymous"></script>

  <!-- Leaflet plugin for permalink/URL hash, served locally, originally from https://github.com/MarcChasse/leaflet.Permalink -->
  <script src="./scripts/leaflet.permalink.min.js" integrity="sha512-p64i/liUcr00za2WMn8dnb6fzu8Ok86e65VxvYy2dbNgoIAU86yL9Dk/lsuIU0lnDsAWoGVdQ0FbSG1zI2X9yg=="></script>

  <!-- scripts for page -->
  <script type="text/javascript">
    'use strict';

    // calculate user's pixel ratio, better for maps on high pixel-density screens
    // default to 1 if not available
    // from https://tile.gbif.org/ui/3031/EPSG3031-leaflet.js
    const pixel_ratio = parseInt(window.devicePixelRatio) || 1;

    // maximum zoom level (set to higher number for more zoom)
    const max_zoom = 6;
    // tile size for OpenStreetMap base layer
    const tile_size = 512;

    // extent of map to equator (based on tile size of 512),
    // see https://tile.gbif.org/ui/
    // note because of the projection the extent will be a circle, with Antarctica in the center
    // however the overall map will be square (with blanks in corners)
    const extent = 12367396.2185;
    // generate zoom resolutions array
    // will end up with array starting at around 48000 (fully zoomed out) to â‰ˆ188
    // needed for GBIF tiles - changing generated resolutions will impact tiles!
    const resolutions = Array(max_zoom + 1).fill().map((_, i) => ( extent / tile_size / Math.pow(2, i-1) ));

    // create EPSG3031 coordinate reference system (CRS) for Leaflet
    // requires proj4 & proj4leaflet
    // adapted from https://github.com/nasa-gibs/gibs-web-examples/blob/master/examples/leaflet/antarctic-epsg3031.js,
    // https://tile.gbif.org/ui/3031/EPSG3031-leaflet.js
    const EPSG3031 = new L.Proj.CRS(
      // name
      'EPSG:3031',
      // proj4 definition of CRS
      // see https://spatialreference.org/ref/epsg/3031/, https://epsg.io/3031
      // cspell: disable-next-line
      '+proj=stere +lat_0=-90 +lat_ts=-71 +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs',
      {
        // top left point of the map
        origin: [-extent, extent],
        // bounds of the CRS in projected coordinates (i.e. from top left point
        // to bottom right point)
        projectedBounds: L.bounds(L.point(-extent, extent), L.point(extent, -extent)),
        // zoom resolutions
        resolutions: resolutions
      }
    );

    // set up permalink/URL hash, adapted from https://github.com/MarcChasse/leaflet.Permalink
    // default zoom level can see whole Antarctic continent for desktops
    // zoom out for high pixel density on mobile (3)
    // center on 90 degrees south
    const map_url_hash = L.Permalink.getMapLocation(pixel_ratio > 1 ? 2 : 3, [-90, 0]);

    // set map view (center, zoom, CRS)
    const map = L.map('map', {
      // center and zoom from permalink
      center: map_url_hash.center,
      zoom: map_url_hash.zoom || 2,
      // minimum & maximum zoom
      minZoom: 1,
      maxZoom: max_zoom,
      // CRS
      crs: EPSG3031,
      // disable jumping to a copy of the map (plays up on mobile)
      worldCopyJump: false
    });

    // now that we've loaded tiles, initialise permalink/URL hash
    L.Permalink.setup(map);

    // basemap (from https://tile.gbif.org/ui/)
    // use light style, SRS 3031
    L.tileLayer('https://tile.gbif.org/3031/omt/{z}/{x}/{y}@{r}x.png?style=gbif-light'.replace('{r}', pixel_ratio), {
      tileSize: tile_size,
      // cache tiles (much faster)
      // once fetched from remote server, subsequent network
      // requests will be to "blob:" (IndexedDB)
      // from https://github.com/MazeMap/Leaflet.TileLayer.PouchDBCached
      useCache: true,
      crossOrigin: true,
      // use canvas renderer
      preferCanvas: true,
      // set CSS class so can style
      className: 'basemap-layer',
      // attribution
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright" rel="noopener noreferrer">OpenStreetMap</a> contributors, &copy; <a href="https://openmaptiles.org" rel="noopener noreferrer">OpenMapTiles</a>'
    }).addTo(map);

    // overall attribution and reference for CRS (will be merged with layer attributions)
    // by default, bottom-right corner
    map.attributionControl.addAttribution('&copy; <a href="http://ccamlr.org" rel="noopener noreferrer">CCAMLR</a> | Projection: <a href="https://spatialreference.org/ref/epsg/wgs-84-antarctic-polar-stereographic/" rel="noopener noreferrer">EPSG:3031</a> | <a href="https://github.com/thomas-ccamlr/leaflet-gis-test/blob/main/LICENSE" rel="noopener noreferrer">MIT License</a>');

    // if on mobile, remove zoom control
    // not needed on mobile due to pinch zooming, double-tap zooming
    // adapted from https://gis.stackexchange.com/a/259718
    if (L.Browser.mobile) {
      // remove zoom control
      map.removeControl(map.zoomControl);
    }

    // create scale control, see https://www.tutorialspoint.com/leafletjs/leafletjs_controls.htm
    // and add scale control to map
    // by default, bottom-left corner
    map.addControl(new L.control.scale());

    // create a new watermark control, with a single image
    // adapted from https://leafletjs.com/examples/extending/watermark.html
    L.Control.Watermark = L.Control.extend({
      // return logo image HTML element
      onAdd: () => {
        const img = L.DomUtil.create('img');
        // set attributes of image
        img.src = './logo.png?v=1';
        // hard-code size to 125 pixels; will retain same size when map is zoomed
        img.style.width = '125px';
        img.style.height = '125px';
        // make image partially transparent
        img.style.opacity = '0.7';
        // add accessibility hints (as the image is decorative, empty description)
        img.alt = '';
        img.role = 'presentation';
        // return image element
        return img;
      }
    });
    // add watermark control to map (defaults to upper-right position)
    map.addControl(new L.Control.Watermark());

    // create a custom SVG icon for VMEs
    // adapted from https://onestepcode.com/leaflet-markers-svg-icons/
    const svgVmeIcon = L.divIcon({
      html: '<svg width="10" height="10" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" fill="#FF8A6D"/></svg>',
      className: 'vme-icon',
      // 10 by 10 pixel circle
      iconSize: [10, 10],
      // icon anchor in center of circle
      iconAnchor: [5, 5]
    });

    // function called once for each created feature
    // add popup tooltip from "name" (and "description" if it exists) properties
    // in GeoJSON
    // adapted from https://javascript.tutorialink.com/dynamically-loading-multiple-external-geojson-data-files-and-calling-multiple-layers-dynamically-using-leaflet/
    const addPopupFromFeatureProperties = (feature, layer) => {
      // create tooltip text from "name" and "description" properties
      // start with initially empty tooltip
      let tooltip = '';
      // if "name" property exists, append to tooltip
      if (feature.properties && feature.properties.name) {
        tooltip += '<strong>' + feature.properties.name + '&nbsp;</strong>';
      }
      // if "description" property exists, append to tooltip
      if (feature.properties && feature.properties.description) {
        tooltip += feature.properties.description;
      }
      // if we have tooltip text, add it
      if (tooltip && tooltip !== '') {
        // create a popup with no close button, "#close" interferes with permalink
        // plugin
        layer.bindPopup(tooltip, { closeButton: false });
      }
    };

    // function to style GeoJSON points as custom VME icons
    const vmeIconPoint = (geoJsonPoint, latlng) => {
      return L.marker(latlng, { icon: svgVmeIcon });
    };
    
    // function to load a GeoJSON file in passed URL
    // URL can be relative
    const loadGeoJSON = async (url) => {
      // load the VME JSON file
      const response = await fetch(url);
      // if the file was not able to be loaded, error and leave
      if (!response.ok) {
        const message = `There was an error loading the GeoJSON file "${url}": ${response.status}`;
        throw new Error(message);
      }
      // if we get to here, we got a response; convert response (string) to JSON object
      const json = await response.json();
      // return JSON object
      return json;
    };
    
    // load VMEs from GeoJSON file
    loadGeoJSON('./layers/ccamlr-vmes.json').then(data => {
      // add as a GeoJSON layer, call custom function to style points as VME icons, and add popup tooltips
      L.geoJSON(data, { pointToLayer: vmeIconPoint, onEachFeature: addPopupFromFeatureProperties }).addTo(map);
    });
  </script>
</body>
</html>